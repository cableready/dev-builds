!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("morphdom")):"function"==typeof define&&define.amd?define(["exports","morphdom"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).CableReady={},e.morphdom)}(this,(function(e,t){"use strict";function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=n(t),r="5.0.0-pre9";const s={INPUT:!0,TEXTAREA:!0,SELECT:!0},a={INPUT:!0,TEXTAREA:!0,OPTION:!0},i={"datetime-local":!0,"select-multiple":!0,"select-one":!0,color:!0,date:!0,datetime:!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,textarea:!0,time:!0,url:!0,week:!0};let l;var c={get element(){return l},set(e){l=e}};const u=e=>s[e.tagName]&&i[e.type],d=e=>{const t=(e&&e.nodeType===Node.ELEMENT_NODE?e:document.querySelector(e))||c.element;t&&t.focus&&t.focus()},m=(e,t,n={})=>{const o=new CustomEvent(t,{bubbles:!0,cancelable:!0,detail:n});e.dispatchEvent(o),window.jQuery&&window.jQuery(e).trigger(t,n)},h=e=>document.evaluate(e,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue,p=e=>{const t=document.evaluate(e,document,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null),n=[];for(let e=0;e<t.snapshotLength;e++)n.push(t.snapshotItem(e));return n},f=e=>Array.from(e).flat(),b=(e,t)=>{Array.from(e.selectAll?e.element:[e.element]).forEach(t)},y=(g=function(e,t,n){return e+(n?"-":"")+t.toLowerCase()},function(e){return w(e).reduce(g,"")});var g;const w=e=>(e=null==e?"":e).match(/([A-Z]{2,}|[0-9]+|[A-Z]?[a-z]+|[A-Z])/g)||[],E=(e,t)=>!e.cancel&&(e.delay?setTimeout(t,e.delay):t(),!0),v=(e,t)=>m(e,`cable-ready:before-${y(t.operation)}`,t),A=(e,t)=>m(e,`cable-ready:after-${y(t.operation)}`,t);function S(e,t){let n;return(...o)=>{clearTimeout(n),n=setTimeout((()=>e.apply(this,o)),t)}}function C(e){if(!e.ok)throw Error(e.statusText);return e}function T(e){return void 0===e||["string","number","boolean"].includes(typeof e)||console.warn(`Operation expects a string, number or boolean, but got ${e} (${typeof e})`),null!=e?e:""}function O(e){return void 0!==e&&"string"!=typeof e&&console.warn(`Operation expects a string, but got ${e} (${typeof e})`),null!=e?String(e):""}function M(e){return void 0===e||Array.isArray(e)||console.warn(`Operation expects an array, but got ${e} (${typeof e})`),null!=e?Array.from(e):[]}function x(e){return void 0!==e&&"object"!=typeof e&&console.warn(`Operation expects an object, but got ${e} (${typeof e})`),null!=e?Object(e):{}}function R(e){return void 0===e||Array.isArray(e)||"string"==typeof e||console.warn(`Operation expects an Array or a String, but got ${e} (${typeof e})`),null==e?"":Array.isArray(e)?Array.from(e):String(e)}async function k(e,t){try{const n=await fetch(e,{headers:{"X-REQUESTED-WITH":"XmlHttpRequest",...t}});if(null==n)return;return C(n),n}catch(t){console.error(`Could not fetch ${e}`)}}var L=Object.freeze({__proto__:null,isTextInput:u,assignFocus:d,dispatch:m,xpathToElement:h,xpathToElementArray:p,getClassNames:f,processElements:b,operate:E,before:v,after:A,debounce:S,handleErrors:C,graciouslyFetch:k,kebabize:y,safeScalar:T,safeString:O,safeArray:M,safeObject:x,safeStringOrArray:R,fragmentToString:function(e){return(new XMLSerializer).serializeToString(e)}});const $={},P=new Proxy($,{get:(e,t)=>t in e?e[t]:()=>{console.error(`CableReady: No plugin registered for ${t}. Make sure to call CableReady.registerPlugin during initialization. For example:\n\nimport CableReady from 'cable_ready'\nimport ${t} from '${t}'\nCableReady.registerPlugin('${t}', ${t})`)}}),H=(e,t)=>{$[e]=t};var _=Object.freeze({__proto__:null,register:H,default:P});const N=e=>(t,n)=>!D.map((o=>"function"!=typeof o||o(e,t,n))).includes(!1),j=e=>t=>{F.forEach((n=>{"function"==typeof n&&n(e,t)}))},q=(e,t,n)=>!(!a[t.tagName]&&t.isEqualNode(n)),I=(e,t,n)=>t!==c.element||!t.isContentEditable,U=(e,t,n)=>{const{permanentAttributeName:o}=e;if(!o)return!0;const r=t.closest(`[${o}]`);if(!r&&t===c.element&&u(t)){const e={value:!0};return Array.from(n.attributes).forEach((n=>{e[n.name]||t.setAttribute(n.name,n.value)})),!1}return!r},D=[q,U,I],F=[];var z=Object.freeze({__proto__:null,shouldMorphCallbacks:D,didMorphCallbacks:F,shouldMorph:N,didMorph:j,verifyNotMutable:q,verifyNotContentEditable:I,verifyNotPermanent:U}),X={append:e=>{b(e,(t=>{v(t,e),E(e,(()=>{const{html:n,focusSelector:o}=e;t.insertAdjacentHTML("beforeend",T(n)),d(o)})),A(t,e)}))},graft:e=>{b(e,(t=>{v(t,e),E(e,(()=>{const{parent:n,focusSelector:o}=e,r=document.querySelector(n);r&&(r.appendChild(t),d(o))})),A(t,e)}))},innerHtml:e=>{b(e,(t=>{v(t,e),E(e,(()=>{const{html:n,focusSelector:o}=e;t.innerHTML=T(n),d(o)})),A(t,e)}))},insertAdjacentHtml:e=>{b(e,(t=>{v(t,e),E(e,(()=>{const{html:n,position:o,focusSelector:r}=e;t.insertAdjacentHTML(o||"beforeend",T(n)),d(r)})),A(t,e)}))},insertAdjacentText:e=>{b(e,(t=>{v(t,e),E(e,(()=>{const{text:n,position:o,focusSelector:r}=e;t.insertAdjacentText(o||"beforeend",T(n)),d(r)})),A(t,e)}))},outerHtml:e=>{b(e,(t=>{const n=t.parentElement,o=n&&Array.from(n.children).indexOf(t);v(t,e),E(e,(()=>{const{html:n,focusSelector:o}=e;t.outerHTML=T(n),d(o)})),A(n?n.children[o]:document.documentElement,e)}))},prepend:e=>{b(e,(t=>{v(t,e),E(e,(()=>{const{html:n,focusSelector:o}=e;t.insertAdjacentHTML("afterbegin",T(n)),d(o)})),A(t,e)}))},remove:e=>{b(e,(t=>{v(t,e),E(e,(()=>{const{focusSelector:n}=e;t.remove(),d(n)})),A(document,e)}))},replace:e=>{b(e,(t=>{const n=t.parentElement,o=n&&Array.from(n.children).indexOf(t);v(t,e),E(e,(()=>{const{html:n,focusSelector:o}=e;t.outerHTML=T(n),d(o)})),A(n?n.children[o]:document.documentElement,e)}))},textContent:e=>{b(e,(t=>{v(t,e),E(e,(()=>{const{text:n,focusSelector:o}=e;t.textContent=T(n),d(o)})),A(t,e)}))},addCssClass:e=>{b(e,(t=>{v(t,e),E(e,(()=>{const{name:n}=e;t.classList.add(...f([R(n)]))})),A(t,e)}))},removeAttribute:e=>{b(e,(t=>{v(t,e),E(e,(()=>{const{name:n}=e;t.removeAttribute(O(n))})),A(t,e)}))},removeCssClass:e=>{b(e,(t=>{v(t,e),E(e,(()=>{const{name:n}=e;t.classList.remove(...f([R(n)])),0===t.classList.length&&t.removeAttribute("class")})),A(t,e)}))},setAttribute:e=>{b(e,(t=>{v(t,e),E(e,(()=>{const{name:n,value:o}=e;t.setAttribute(O(n),T(o))})),A(t,e)}))},setDatasetProperty:e=>{b(e,(t=>{v(t,e),E(e,(()=>{const{name:n,value:o}=e;t.dataset[O(n)]=T(o)})),A(t,e)}))},setProperty:e=>{b(e,(t=>{v(t,e),E(e,(()=>{const{name:n,value:o}=e;n in t&&(t[O(n)]=T(o))})),A(t,e)}))},setStyle:e=>{b(e,(t=>{v(t,e),E(e,(()=>{const{name:n,value:o}=e;t.style[O(n)]=T(o)})),A(t,e)}))},setStyles:e=>{b(e,(t=>{v(t,e),E(e,(()=>{const{styles:n}=e;for(let[e,o]of Object.entries(n))t.style[O(e)]=T(o)})),A(t,e)}))},setValue:e=>{b(e,(t=>{v(t,e),E(e,(()=>{const{value:n}=e;t.value=T(n)})),A(t,e)}))},dispatchEvent:e=>{b(e,(t=>{v(t,e),E(e,(()=>{const{name:n,detail:o}=e;m(t,O(n),x(o))})),A(t,e)}))},invokeMethod:e=>{b(e,(t=>{v(t,e),E(e,(()=>{let t;const{element:n,receiver:o,method:r,args:s}=e,a=O(r).split(".");switch(o){case"window":t=window;break;case"document":t=document;break;default:t=n}let i=t;const l=a.reduce(((e,t)=>(i=e,e[t]||{})),t);l instanceof Function?l.apply(i,s||[]):console.warn(`CableReady invoke_method operation failed due to missing '${r}' method for:`,t)})),A(t,e)}))},setMeta:e=>{v(document,e),E(e,(()=>{const{name:t,content:n}=e;let o=document.head.querySelector(`meta[name='${t}']`);o||(o=document.createElement("meta"),o.name=O(t),document.head.appendChild(o)),o.content=T(n)})),A(document,e)},setTitle:e=>{v(document,e),E(e,(()=>{const{title:t}=e;document.title=T(t)})),A(document,e)},clearStorage:e=>{v(document,e),E(e,(()=>{const{type:t}=e;("session"===t?sessionStorage:localStorage).clear()})),A(document,e)},go:e=>{v(window,e),E(e,(()=>{const{delta:t}=e;history.go(t)})),A(window,e)},pushState:e=>{v(window,e),E(e,(()=>{const{state:t,title:n,url:o}=e;history.pushState(x(t),O(n),O(o))})),A(window,e)},redirectTo:e=>{v(window,e),E(e,(()=>{let{url:t,action:n,turbo:o}=e;n=n||"advance",t=O(t),void 0===o&&(o=!0),o?(window.Turbo&&window.Turbo.visit(t,{action:n}),window.Turbolinks&&window.Turbolinks.visit(t,{action:n}),window.Turbo||window.Turbolinks||(window.location.href=t)):window.location.href=t})),A(window,e)},reload:e=>{v(window,e),E(e,(()=>{window.location.reload()})),A(window,e)},removeStorageItem:e=>{v(document,e),E(e,(()=>{const{key:t,type:n}=e;("session"===n?sessionStorage:localStorage).removeItem(O(t))})),A(document,e)},replaceState:e=>{v(window,e),E(e,(()=>{const{state:t,title:n,url:o}=e;history.replaceState(x(t),O(n),O(o))})),A(window,e)},scrollIntoView:e=>{const{element:t}=e;v(t,e),E(e,(()=>{t.scrollIntoView(e)})),A(t,e)},setCookie:e=>{v(document,e),E(e,(()=>{const{cookie:t}=e;document.cookie=T(t)})),A(document,e)},setFocus:e=>{const{element:t}=e;v(t,e),E(e,(()=>{d(t)})),A(t,e)},setStorageItem:e=>{v(document,e),E(e,(()=>{const{key:t,value:n,type:o}=e;("session"===o?sessionStorage:localStorage).setItem(O(t),T(n))})),A(document,e)},consoleLog:e=>{v(document,e),E(e,(()=>{const{message:t,level:n}=e;n&&["warn","info","error"].includes(n)?console[n](t):console.log(t)})),A(document,e)},consoleTable:e=>{v(document,e),E(e,(()=>{const{data:t,columns:n}=e;console.table(t,M(n))})),A(document,e)},notification:e=>{v(document,e),E(e,(()=>{const{title:t,options:n}=e;Notification.requestPermission().then((o=>{e.permission=o,"granted"===o&&new Notification(O(t),x(n))}))})),A(document,e)},morph:e=>{b(e,(t=>{const{html:n}=e,o=document.createElement("template");o.innerHTML=String(T(n)).trim(),e.content=o.content;const r=t.parentElement,s=r&&Array.from(r.children).indexOf(t);v(t,e),E(e,(()=>{const{childrenOnly:n,focusSelector:r}=e;P.morphdom(t,n?o.content:o.innerHTML,{childrenOnly:!!n,onBeforeElUpdated:N(e),onElUpdated:j(e)}),d(r)})),console.warn('The "morph" operation is deprecated in CableReady v5 and will be removed in v6. Use "morphdom" or similar instead.'),A(r?r.children[s]:document.documentElement,e)}))},morphdom:e=>{b(e,(t=>{const{html:n}=e,o=document.createElement("template");o.innerHTML=String(T(n)).trim(),e.content=o.content;const r=t.parentElement,s=r&&Array.from(r.children).indexOf(t);v(t,e),E(e,(()=>{const{childrenOnly:n,focusSelector:r}=e;P.morphdom(t,n?o.content:o.innerHTML,{childrenOnly:!!n,onBeforeElUpdated:N(e),onElUpdated:j(e)}),d(r)})),A(r?r.children[s]:document.documentElement,e)}))}};window.CableReadyOperationsStore||(window.CableReadyOperationsStore=X);const V=e=>{window.CableReadyOperationsStore={...window.CableReadyOperationsStore,...e}};var Y={get all(){return window.CableReadyOperationsStore},getAll:()=>window.CableReadyOperationsStore};let B="warn";var Q={get behavior(){return B},set(e){["warn","ignore","event","exception"].includes(e)?B=e:console.warn("Invalid 'onMissingElement' option. Defaulting to 'warn'.")}};const Z=(e,t={onMissingElement:Q.behavior})=>{const n={};e.forEach((e=>{e.batch&&(n[e.batch]=n[e.batch]?++n[e.batch]:1)})),e.forEach((e=>{const o=e.operation;try{if(e.selector?e.xpath?e.element=e.selectAll?p(e.selector):h(e.selector):e.element=e.selectAll?document.querySelectorAll(e.selector):document.querySelector(e.selector):e.element=document,e.element||"ignore"!==t.onMissingElement){c.set(document.activeElement);const t=Y.all[o];t?(t(e),e.batch&&0==--n[e.batch]&&m(document,"cable-ready:batch-complete",{batch:e.batch})):console.error(`CableReady couldn't find the "${o}" operation. Make sure you use the camelized form when calling an operation method.`)}}catch(n){if(e.element)console.error(`CableReady detected an error in ${o||"operation"}: ${n.message}. If you need to support older browsers make sure you've included the corresponding polyfills. https://docs.stimulusreflex.com/setup#polyfills-for-ie11.`),console.error(n);else{const n=`CableReady ${o||""} operation failed due to missing DOM element for selector: '${e.selector}'`;switch(t.onMissingElement){case"ignore":break;case"event":m(document,"cable-ready:missing-element",{warning:n,operation:e});break;case"exception":throw n;default:console.warn(n)}}}}))};class J extends HTMLElement{static define(){customElements.get("cable-ready")||customElements.define("cable-ready",this)}connectedCallback(){setTimeout((()=>{try{const e=JSON.parse(this.scriptElement.textContent);Z(e)}catch(e){console.error(e)}finally{try{this.remove()}catch{}}}))}get scriptElement(){if(this.firstElementChild instanceof HTMLScriptElement&&"application/json"===this.firstElementChild.getAttribute("type"))return this.firstElementChild;throw new Error('First child element in a `<cable-ready>` tag must be `<script type="application/json">`.')}}class W extends HTMLElement{disconnectedCallback(){this.channel&&this.channel.unsubscribe()}createSubscription(e,t,n){this.channel=e.subscriptions.create({channel:t,identifier:this.identifier},{received:n})}get preview(){return document.documentElement.hasAttribute("data-turbolinks-preview")||document.documentElement.hasAttribute("data-turbo-preview")}get identifier(){return this.getAttribute("identifier")}}let G;const K=[25,50,75,100,200,250,500,800,1e3,2e3],ee=async(e=0)=>{if(G)return G;if(e>=K.length)throw new Error("Couldn't obtain a Action Cable consumer within 5s");var t;return await(t=K[e],new Promise((e=>setTimeout(e,t)))),await ee(e+1)};var te={setConsumer(e){G=e},get consumer(){return G},getConsumer:async()=>await ee()};class ne extends W{static define(){customElements.get("stream-from")||customElements.define("stream-from",this)}async connectedCallback(){if(this.preview)return;const e=await te.getConsumer();e?this.createSubscription(e,"CableReady::Stream",this.performOperations.bind(this)):console.error("The `stream_from` helper cannot connect. You must initialize CableReady with an Action Cable consumer.")}performOperations(e){e.cableReady&&Z(e.operations,{onMissingElement:this.onMissingElement})}get onMissingElement(){const e=this.getAttribute("missing")||Q.behavior;return["warn","ignore","event"].includes(e)?e:(console.warn("Invalid 'missing' attribute. Defaulting to 'warn'."),"warn")}}class oe extends W{static define(){customElements.get("updates-for")||customElements.define("updates-for",this)}constructor(){super();this.attachShadow({mode:"open"}).innerHTML="\n<style>\n  :host {\n    display: block;\n  }\n</style>\n<slot></slot>\n"}async connectedCallback(){if(this.preview)return;this.update=S(this.update.bind(this),this.debounce);const e=await te.getConsumer();e?this.createSubscription(e,"CableReady::Stream",this.update):console.error("The `updates-for` helper cannot connect. You must initialize CableReady with an Action Cable consumer.")}async update(e){const t=Array.from(document.querySelectorAll(this.query),(e=>new re(e))).filter((t=>t.shouldUpdate(e)));if(0===t.length||t[0].element!==this)return;c.set(document.activeElement),this.html={};const n=[...new Set(t.map((e=>e.url)))];await Promise.all(n.map((async e=>{if(!this.html.hasOwnProperty(e)){const t=await k(e,{"X-Cable-Ready":"update"});this.html[e]=await t.text()}}))),this.index={},t.forEach((t=>{this.index.hasOwnProperty(t.url)?this.index[t.url]++:this.index[t.url]=0,t.process(e,this.html,this.index)}))}get query(){return`updates-for[identifier="${this.identifier}"]`}get identifier(){return this.getAttribute("identifier")}get debounce(){return this.hasAttribute("debounce")?parseInt(this.getAttribute("debounce")):20}}class re{constructor(e){this.element=e}async process(e,t,n){const o=n[this.url],r=document.createElement("template");this.element.setAttribute("updating","updating"),r.innerHTML=String(t[this.url]).trim(),await this.resolveTurboFrames(r.content);const s=r.content.querySelectorAll(this.query);if(s.length<=o)return void console.warn(`Update aborted due to insufficient number of elements. The offending url is ${this.url}.`);const a={element:this.element,html:s[o],permanentAttributeName:"data-ignore-updates"};m(this.element,"cable-ready:before-update",a),P.morphdom(this.element,s[o],{childrenOnly:!0,onBeforeElUpdated:N(a),onElUpdated:e=>{this.element.removeAttribute("updating"),m(this.element,"cable-ready:after-update",a),d(a.focusSelector)}})}async resolveTurboFrames(e){const t=[...e.querySelectorAll('turbo-frame[src]:not([loading="lazy"])')];return Promise.all(t.map((t=>new Promise((async n=>{const o=await k(t.getAttribute("src"),{"Turbo-Frame":t.id,"X-Cable-Ready":"update"}),r=document.createElement("template");r.innerHTML=await o.text(),await this.resolveTurboFrames(r.content);const s=`turbo-frame#${t.id}`,a=r.content.querySelector(s),i=a?a.innerHTML.trim():"";e.querySelector(s).innerHTML=i,n()})))))}shouldUpdate(e){return!this.ignoresInnerUpdates&&this.hasChangesSelectedForUpdate(e)}hasChangesSelectedForUpdate(e){const t=this.element.getAttribute("only");return!(t&&e.changed&&!t.split(" ").some((t=>e.changed.includes(t))))}get ignoresInnerUpdates(){return this.element.hasAttribute("ignore-inner-updates")&&this.element.hasAttribute("performing-inner-update")}get url(){return this.element.hasAttribute("url")?this.element.getAttribute("url"):location.href}get identifier(){return this.element.identifier}get query(){return this.element.query}}const se=e=>{const t=e&&e.parentElement&&e.parentElement.closest("updates-for");t&&(t.setAttribute("performing-inner-update",""),se(t))},ae=e=>{const t=e&&e.parentElement&&e.parentElement.closest("updates-for");t&&(t.removeAttribute("performing-inner-update"),ae(t))},ie=()=>{document.addEventListener("stimulus-reflex:before",(e=>{se(e.detail.element)})),document.addEventListener("stimulus-reflex:after",(e=>{setTimeout((()=>{ae(e.detail.element)}))})),document.addEventListener("turbo:submit-start",(e=>{se(e.target)})),document.addEventListener("turbo:submit-end",(e=>{setTimeout((()=>{ae(e.target)}))})),J.define(),ne.define(),oe.define()};H("morphdom",o.default);const le={perform:Z,performAsync:(e,t={onMissingElement:Q.behavior})=>new Promise(((n,o)=>{try{n(Z(e,t))}catch(e){o(e)}})),shouldMorphCallbacks:D,didMorphCallbacks:F,initialize:(e={})=>{const{consumer:t,onMissingElement:n,plugins:o}=e;t?te.setConsumer(t):console.error("CableReady requires a reference to your Action Cable `consumer` for its helpers to function.\nEnsure that you have imported the `CableReady` package as well as `consumer` from your `channels` folder, then call `CableReady.initialize({ consumer })`."),n&&MissingElement.set(n),o&&Object.keys(o).forEach((e=>H(e,o[e]))),ie()},registerPlugin:H,addOperation:(e,t)=>{const n={};n[e]=t,V(n)},addOperations:e=>{V(e)},version:r,cable:te,get DOMOperations(){return console.warn("DEPRECATED: Please use `CableReady.operations` instead of `CableReady.DOMOperations`"),Y.all},get operations(){return Y.all},get consumer(){return te.consumer}};window.CableReady=le,e.CableReadyElement=J,e.MorphCallbacks=z,e.Plugins=_,e.StreamFromElement=ne,e.SubscribingElement=W,e.UpdatesForElement=oe,e.Utils=L,e.default=le,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=cable_ready.umd.min.js.map
