import e from"morphdom";var t="5.0.0-pre9";const n={INPUT:!0,TEXTAREA:!0,SELECT:!0},o={INPUT:!0,TEXTAREA:!0,OPTION:!0},r={"datetime-local":!0,"select-multiple":!0,"select-one":!0,color:!0,date:!0,datetime:!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,textarea:!0,time:!0,url:!0,week:!0};let s;var a={get element(){return s},set(e){s=e}};const l=e=>n[e.tagName]&&r[e.type],i=e=>{const t=(e&&e.nodeType===Node.ELEMENT_NODE?e:document.querySelector(e))||a.element;t&&t.focus&&t.focus()},c=(e,t,n={})=>{const o=new CustomEvent(t,{bubbles:!0,cancelable:!0,detail:n});e.dispatchEvent(o),window.jQuery&&window.jQuery(e).trigger(t,n)},u=e=>document.evaluate(e,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue,d=e=>{const t=document.evaluate(e,document,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null),n=[];for(let e=0;e<t.snapshotLength;e++)n.push(t.snapshotItem(e));return n},m=e=>Array(e).flat(),h=(e,t)=>{Array.from(e.selectAll?e.element:[e.element]).forEach(t)},p=e=>e.split("").map(((e,t)=>e.toUpperCase()===e?`${0!==t?"-":""}${e.toLowerCase()}`:e)).join(""),f=(e,t)=>!e.cancel&&(e.delay?setTimeout(t,e.delay):t(),!0),b=(e,t)=>c(e,`cable-ready:before-${p(t.operation)}`,t),y=(e,t)=>c(e,`cable-ready:after-${p(t.operation)}`,t);function w(e,t){let n;return(...o)=>{clearTimeout(n),n=setTimeout((()=>e.apply(this,o)),t)}}function g(e){if(!e.ok)throw Error(e.statusText);return e}async function E(e,t){try{const n=await fetch(e,{headers:{"X-REQUESTED-WITH":"XmlHttpRequest",...t}});if(null==n)return;return g(n),n}catch(t){console.error(`Could not fetch ${e}`)}}var v=Object.freeze({__proto__:null,isTextInput:l,assignFocus:i,dispatch:c,xpathToElement:u,xpathToElementArray:d,getClassNames:m,processElements:h,operate:f,before:b,after:y,debounce:w,handleErrors:g,graciouslyFetch:E,kebabize:p});const T=e=>(t,n)=>!M.map((o=>"function"!=typeof o||o(e,t,n))).includes(!1),A=e=>t=>{k.forEach((n=>{"function"==typeof n&&n(e,t)}))},S=(e,t,n)=>!(!o[t.tagName]&&t.isEqualNode(n)),C=(e,t,n)=>t!==a.element||!t.isContentEditable,x=(e,t,n)=>{const{permanentAttributeName:o}=e;if(!o)return!0;const r=t.closest(`[${o}]`);if(!r&&t===a.element&&l(t)){const e={value:!0};return Array.from(n.attributes).forEach((n=>{e[n.name]||t.setAttribute(n.name,n.value)})),!1}return!r},M=[S,x,C],k=[];var O=Object.freeze({__proto__:null,shouldMorphCallbacks:M,didMorphCallbacks:k,shouldMorph:T,didMorph:A,verifyNotMutable:S,verifyNotContentEditable:C,verifyNotPermanent:x}),R={append:e=>{h(e,(t=>{b(t,e),f(e,(()=>{const{html:n,focusSelector:o}=e;t.insertAdjacentHTML("beforeend",null!=n?n:""),i(o)})),y(t,e)}))},graft:e=>{h(e,(t=>{b(t,e),f(e,(()=>{const{parent:n,focusSelector:o}=e,r=document.querySelector(n);r&&(r.appendChild(t),i(o))})),y(t,e)}))},innerHtml:e=>{h(e,(t=>{b(t,e),f(e,(()=>{const{html:n,focusSelector:o}=e;t.innerHTML=null!=n?n:"",i(o)})),y(t,e)}))},insertAdjacentHtml:e=>{h(e,(t=>{b(t,e),f(e,(()=>{const{html:n,position:o,focusSelector:r}=e;t.insertAdjacentHTML(o||"beforeend",null!=n?n:""),i(r)})),y(t,e)}))},insertAdjacentText:e=>{h(e,(t=>{b(t,e),f(e,(()=>{const{text:n,position:o,focusSelector:r}=e;t.insertAdjacentText(o||"beforeend",null!=n?n:""),i(r)})),y(t,e)}))},morph:t=>{h(t,(n=>{const{html:o}=t,r=document.createElement("template");r.innerHTML=String(o).trim(),t.content=r.content;const s=n.parentElement,a=Array.from(s.children).indexOf(n);b(n,t),f(t,(()=>{const{childrenOnly:o,focusSelector:s}=t;e(n,o?r.content:r.innerHTML,{childrenOnly:!!o,onBeforeElUpdated:T(t),onElUpdated:A(t)}),i(s)})),y(s.children[a],t)}))},outerHtml:e=>{h(e,(t=>{const n=t.parentElement,o=Array.from(n.children).indexOf(t);b(t,e),f(e,(()=>{const{html:n,focusSelector:o}=e;t.outerHTML=null!=n?n:"",i(o)})),y(n.children[o],e)}))},prepend:e=>{h(e,(t=>{b(t,e),f(e,(()=>{const{html:n,focusSelector:o}=e;t.insertAdjacentHTML("afterbegin",null!=n?n:""),i(o)})),y(t,e)}))},remove:e=>{h(e,(t=>{b(t,e),f(e,(()=>{const{focusSelector:n}=e;t.remove(),i(n)})),y(document,e)}))},replace:e=>{h(e,(t=>{const n=t.parentElement,o=Array.from(n.children).indexOf(t);b(t,e),f(e,(()=>{const{html:n,focusSelector:o}=e;t.outerHTML=null!=n?n:"",i(o)})),y(n.children[o],e)}))},textContent:e=>{h(e,(t=>{b(t,e),f(e,(()=>{const{text:n,focusSelector:o}=e;t.textContent=null!=n?n:"",i(o)})),y(t,e)}))},addCssClass:e=>{h(e,(t=>{b(t,e),f(e,(()=>{const{name:n}=e;t.classList.add(...m(null!=n?n:""))})),y(t,e)}))},removeAttribute:e=>{h(e,(t=>{b(t,e),f(e,(()=>{const{name:n}=e;t.removeAttribute(n)})),y(t,e)}))},removeCssClass:e=>{h(e,(t=>{b(t,e),f(e,(()=>{const{name:n}=e;t.classList.remove(...m(n))})),y(t,e)}))},setAttribute:e=>{h(e,(t=>{b(t,e),f(e,(()=>{const{name:n,value:o}=e;t.setAttribute(n,null!=o?o:"")})),y(t,e)}))},setDatasetProperty:e=>{h(e,(t=>{b(t,e),f(e,(()=>{const{name:n,value:o}=e;t.dataset[n]=null!=o?o:""})),y(t,e)}))},setProperty:e=>{h(e,(t=>{b(t,e),f(e,(()=>{const{name:n,value:o}=e;n in t&&(t[n]=null!=o?o:"")})),y(t,e)}))},setStyle:e=>{h(e,(t=>{b(t,e),f(e,(()=>{const{name:n,value:o}=e;t.style[n]=null!=o?o:""})),y(t,e)}))},setStyles:e=>{h(e,(t=>{b(t,e),f(e,(()=>{const{styles:n}=e;for(let[e,o]of Object.entries(n))t.style[e]=null!=o?o:""})),y(t,e)}))},setValue:e=>{h(e,(t=>{b(t,e),f(e,(()=>{const{value:n}=e;t.value=null!=n?n:""})),y(t,e)}))},dispatchEvent:e=>{h(e,(t=>{b(t,e),f(e,(()=>{const{name:n,detail:o}=e;c(t,n,o)})),y(t,e)}))},invokeMethod:e=>{h(e,(t=>{b(t,e),f(e,(()=>{let t;const{element:n,receiver:o,method:r,args:s}=e,a=r.split(".");switch(o){case"window":t=window;break;case"document":t=document;break;default:t=n}let l=t;const i=a.reduce(((e,t)=>(l=e,e[t]||{})),t);i instanceof Function?i.apply(l,s||[]):console.warn(`CableReady invoke_method operation failed due to missing '${r}' method for:`,t)})),y(t,e)}))},setMeta:e=>{b(document,e),f(e,(()=>{const{name:t,content:n}=e;let o=document.head.querySelector(`meta[name='${t}']`);o||(o=document.createElement("meta"),o.name=t,document.head.appendChild(o)),o.content=n})),y(document,e)},clearStorage:e=>{b(document,e),f(e,(()=>{const{type:t}=e;("session"===t?sessionStorage:localStorage).clear()})),y(document,e)},go:e=>{b(window,e),f(e,(()=>{const{delta:t}=e;history.go(t)})),y(window,e)},pushState:e=>{b(window,e),f(e,(()=>{const{state:t,title:n,url:o}=e;history.pushState(t||{},null!=n?n:"",o)})),y(window,e)},redirectTo:e=>{b(window,e),f(e,(()=>{let{url:t,action:n,turbo:o}=e;n=n||"advance",void 0===o&&(o=!0),o?(window.Turbo&&window.Turbo.visit(t,{action:n}),window.Turbolinks&&window.Turbolinks.visit(t,{action:n}),window.Turbo||window.Turbolinks||(window.location.href=t)):window.location.href=t})),y(window,e)},reload:e=>{b(window,e),f(e,(()=>{window.location.reload()})),y(window,e)},removeStorageItem:e=>{b(document,e),f(e,(()=>{const{key:t,type:n}=e;("session"===n?sessionStorage:localStorage).removeItem(t)})),y(document,e)},replaceState:e=>{b(window,e),f(e,(()=>{const{state:t,title:n,url:o}=e;history.replaceState(null!=t?t:{},null!=n?n:"",o)})),y(window,e)},scrollIntoView:e=>{const{element:t}=e;b(t,e),f(e,(()=>{t.scrollIntoView(e)})),y(t,e)},setCookie:e=>{b(document,e),f(e,(()=>{const{cookie:t}=e;document.cookie=null!=t?t:""})),y(document,e)},setFocus:e=>{const{element:t}=e;b(t,e),f(e,(()=>{i(t)})),y(t,e)},setStorageItem:e=>{b(document,e),f(e,(()=>{const{key:t,value:n,type:o}=e;("session"===o?sessionStorage:localStorage).setItem(t,null!=n?n:"")})),y(document,e)},consoleLog:e=>{b(document,e),f(e,(()=>{const{message:t,level:n}=e;n&&["warn","info","error"].includes(n)?console[n](null!=t?t:""):console.log(null!=t?t:"")})),y(document,e)},consoleTable:e=>{b(document,e),f(e,(()=>{const{data:t,columns:n}=e;console.table(t,null!=n?n:[])})),y(document,e)},notification:e=>{b(document,e),f(e,(()=>{const{title:t,options:n}=e;Notification.requestPermission().then((o=>{e.permission=o,"granted"===o&&new Notification(null!=t?t:"",n)}))})),y(document,e)}};let L=R;const P=e=>{L={...L,...e}};var N={get all(){return L}};const H=(e,t={emitMissingElementWarnings:!0})=>{const n={};e.forEach((e=>{e.batch&&(n[e.batch]=n[e.batch]?++n[e.batch]:1)})),e.forEach((e=>{const o=e.operation;try{if(e.selector?e.xpath?e.element=e.selectAll?d(e.selector):u(e.selector):e.element=e.selectAll?document.querySelectorAll(e.selector):document.querySelector(e.selector):e.element=document,e.element||t.emitMissingElementWarnings){a.set(document.activeElement);const t=N.all[o];t?(t(e),e.batch&&0==--n[e.batch]&&c(document,"cable-ready:batch-complete",{batch:e.batch})):console.error(`CableReady couldn't find the "${o}" operation. Make sure you use the camelized form when calling an operation method.`)}}catch(t){e.element?(console.error(`CableReady detected an error in ${o||"operation"}: ${t.message}. If you need to support older browsers make sure you've included the corresponding polyfills. https://docs.stimulusreflex.com/setup#polyfills-for-ie11.`),console.error(t)):console.warn(`CableReady ${o||"operation"} failed due to missing DOM element for selector: '${e.selector}'`)}}))};let q;const _=[25,50,75,100,200,250,500,800,1e3,2e3],I=async(e=0)=>{if(q)return q;if(e>=_.length)throw new Error("Couldn't obtain a Action Cable consumer within 5s");var t;return await(t=_[e],new Promise((e=>setTimeout(e,t)))),await I(e+1)};var $={setConsumer(e){q=e},get consumer(){return q},getConsumer:async()=>await I()};class U extends HTMLElement{disconnectedCallback(){this.channel&&this.channel.unsubscribe()}createSubscription(e,t,n){this.channel=e.subscriptions.create({channel:t,identifier:this.identifier},{received:n})}get preview(){return document.documentElement.hasAttribute("data-turbolinks-preview")||document.documentElement.hasAttribute("data-turbo-preview")}get identifier(){return this.getAttribute("identifier")}}class D extends U{async connectedCallback(){if(this.preview)return;const e=await $.getConsumer();e?this.createSubscription(e,"CableReady::Stream",this.performOperations):console.error("The `stream_from` helper cannot connect without an ActionCable consumer.\nPlease run `rails generate cable_ready:helpers` to fix this.")}performOperations(e){e.cableReady&&H(e.operations)}}class j extends U{constructor(){super();this.attachShadow({mode:"open"}).innerHTML="\n<style>\n  :host {\n    display: block;\n  }\n</style>\n<slot></slot>\n"}async connectedCallback(){if(this.preview)return;this.update=w(this.update.bind(this),this.debounce);const e=await $.getConsumer();e?this.createSubscription(e,"CableReady::Stream",this.update):console.error("The `updates-for` helper cannot connect without an ActionCable consumer.\nPlease run `rails generate cable_ready:helpers` to fix this.")}async update(e){const t=Array.from(document.querySelectorAll(this.query),(e=>new F(e)));if(t[0].element!==this)return;a.set(document.activeElement),this.html={};const n=[...new Set(t.map((e=>e.url)))];await Promise.all(n.map((async e=>{if(!this.html.hasOwnProperty(e)){const t=await E(e,{"X-Cable-Ready":"update"});this.html[e]=await t.text()}}))),this.index={},t.forEach((t=>{this.index.hasOwnProperty(t.url)?this.index[t.url]++:this.index[t.url]=0,t.process(e,this.html,this.index)}))}get query(){return`updates-for[identifier="${this.identifier}"]`}get identifier(){return this.getAttribute("identifier")}get debounce(){return this.hasAttribute("debounce")?parseInt(this.getAttribute("debounce")):20}}class F{constructor(e){this.element=e}async process(t,n,o){if(!this.shouldUpdate(t))return;const r=o[this.url],s=document.createElement("template");this.element.setAttribute("updating","updating"),s.innerHTML=String(n[this.url]).trim(),await this.resolveTurboFrames(s.content);const a=s.content.querySelectorAll(this.query);if(a.length<=r)return void console.warn(`Update aborted due to insufficient number of elements. The offending url is ${this.url}.`);const l={element:this.element,html:a[r],permanentAttributeName:"data-ignore-updates"};c(this.element,"cable-ready:before-update",l),e(this.element,a[r],{childrenOnly:!0,onBeforeElUpdated:T(l),onElUpdated:e=>{this.element.removeAttribute("updating"),c(this.element,"cable-ready:after-update",l),i(l.focusSelector)}})}async resolveTurboFrames(e){const t=[...e.querySelectorAll('turbo-frame[src]:not([loading="lazy"])')];return Promise.all(t.map((t=>new Promise((async n=>{const o=await E(t.getAttribute("src"),{"Turbo-Frame":t.id,"X-Cable-Ready":"update"}),r=document.createElement("template");r.innerHTML=await o.text(),await this.resolveTurboFrames(r.content),e.querySelector(`turbo-frame#${t.id}`).innerHTML=String(r.content.querySelector(`turbo-frame#${t.id}`).innerHTML).trim(),n()})))))}shouldUpdate(e){return!this.ignoresInnerUpdates&&this.hasChangesSelectedForUpdate(e)}hasChangesSelectedForUpdate(e){const t=this.element.getAttribute("only");return!(t&&e.changed&&!t.split(" ").some((t=>e.changed.includes(t))))}get ignoresInnerUpdates(){return this.element.hasAttribute("ignore-inner-updates")&&this.element.hasAttribute("performing-inner-update")}get url(){return this.element.hasAttribute("url")?this.element.getAttribute("url"):location.href}get identifier(){return this.element.identifier}get query(){return this.element.query}}const X=e=>{const t=e&&e.parentElement&&e.parentElement.closest("updates-for");t&&(t.setAttribute("performing-inner-update",""),X(t))},z=e=>{const t=e&&e.parentElement&&e.parentElement.closest("updates-for");t&&(t.removeAttribute("performing-inner-update"),z(t))},V={perform:H,performAsync:(e,t={emitMissingElementWarnings:!0})=>new Promise(((n,o)=>{try{n(H(e,t))}catch(e){o(e)}})),shouldMorphCallbacks:M,didMorphCallbacks:k,initialize:(e={})=>{const{consumer:t}=e;document.addEventListener("stimulus-reflex:before",(e=>{X(e.detail.element)})),document.addEventListener("stimulus-reflex:after",(e=>{setTimeout((()=>{z(e.detail.element)}))})),document.addEventListener("turbo:submit-start",(e=>{X(e.target)})),document.addEventListener("turbo:submit-end",(e=>{setTimeout((()=>{z(e.target)}))})),t?$.setConsumer(t):console.error("CableReady requires a reference to your Action Cable `consumer` for its helpers to function.\nEnsure that you have imported the `CableReady` package as well as `consumer` from your `channels` folder, then call `CableReady.initialize({ consumer })`."),customElements.get("stream-from")||customElements.define("stream-from",D),customElements.get("updates-for")||customElements.define("updates-for",j)},addOperation:(e,t)=>{const n={};n[e]=t,P(n)},addOperations:e=>{P(e)},version:t,cable:$,get DOMOperations(){return console.warn("DEPRECATED: Please use `CableReady.operations` instead of `CableReady.DOMOperations`"),N.all},get operations(){return N.all},get consumer(){return $.consumer}};window.CableReady=V;export{O as MorphCallbacks,D as StreamFromElement,U as SubscribingElement,j as UpdatesForElement,v as Utils,V as default};
//# sourceMappingURL=cable_ready.min.js.map
