import e from"morphdom";var t="5.0.0-pre10";const n={INPUT:!0,TEXTAREA:!0,SELECT:!0},r={INPUT:!0,TEXTAREA:!0,OPTION:!0},o={"datetime-local":!0,"select-multiple":!0,"select-one":!0,color:!0,date:!0,datetime:!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,textarea:!0,time:!0,url:!0,week:!0};let a;var s={get element(){return a},set(e){a=e}};const i=e=>n[e.tagName]&&o[e.type],l=e=>{const t=(e&&e.nodeType===Node.ELEMENT_NODE?e:document.querySelector(e))||s.element;t&&t.focus&&t.focus()},c=(e,t,n={})=>{const r=new CustomEvent(t,{bubbles:!0,cancelable:!0,detail:n});e.dispatchEvent(r),window.jQuery&&window.jQuery(e).trigger(t,n)},u=e=>document.evaluate(e,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue,d=(e,t=!1)=>{const n=document.evaluate(e,document,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null),r=[];for(let e=0;e<n.snapshotLength;e++)r.push(n.snapshotItem(e));return t?r.reverse():r},m=e=>Array.from(e).flat(),h=(e,t)=>{Array.from(e.selectAll?e.element:[e.element]).forEach(t)},p=(f=function(e,t,n){return e+(n?"-":"")+t.toLowerCase()},function(e){return b(e).reduce(f,"")});var f;const b=e=>(e=null==e?"":e).match(/([A-Z]{2,}|[0-9]+|[A-Z]?[a-z]+|[A-Z])/g)||[],g=(e,t)=>!e.cancel&&(e.delay?setTimeout(t,e.delay):t(),!0),y=(e,t)=>c(e,`cable-ready:before-${p(t.operation)}`,t),w=(e,t)=>c(e,`cable-ready:after-${p(t.operation)}`,t);function E(e,t=250){let n;return(...r)=>{n&&clearTimeout(n),n=setTimeout((()=>e.apply(this,r)),t)}}function v(e){if(!e.ok)throw Error(e.statusText);return e}function A(e){return void 0===e||["string","number","boolean"].includes(typeof e)||console.warn(`Operation expects a string, number or boolean, but got ${e} (${typeof e})`),null!=e?e:""}function T(e){return void 0!==e&&"string"!=typeof e&&console.warn(`Operation expects a string, but got ${e} (${typeof e})`),null!=e?String(e):""}function S(e){return void 0===e||Array.isArray(e)||console.warn(`Operation expects an array, but got ${e} (${typeof e})`),null!=e?Array.from(e):[]}function C(e){return void 0!==e&&"object"!=typeof e&&console.warn(`Operation expects an object, but got ${e} (${typeof e})`),null!=e?Object(e):{}}function M(e){return void 0===e||Array.isArray(e)||"string"==typeof e||console.warn(`Operation expects an Array or a String, but got ${e} (${typeof e})`),null==e?"":Array.isArray(e)?Array.from(e):String(e)}async function x(e,t){try{const n=await fetch(e,{headers:{"X-REQUESTED-WITH":"XmlHttpRequest",...t}});if(null==n)return;return v(n),n}catch(t){console.error(`Could not fetch ${e}`)}}var O=Object.freeze({__proto__:null,after:w,assignFocus:l,before:y,debounce:E,dispatch:c,fragmentToString:function(e){return(new XMLSerializer).serializeToString(e)},getClassNames:m,graciouslyFetch:x,handleErrors:v,isTextInput:i,kebabize:p,operate:g,processElements:h,safeArray:S,safeObject:C,safeScalar:A,safeString:T,safeStringOrArray:M,xpathToElement:u,xpathToElementArray:d});const L=e=>(t,n)=>!k.map((r=>"function"!=typeof r||r(e,t,n))).includes(!1),$=e=>t=>{q.forEach((n=>{"function"==typeof n&&n(e,t)}))},R=(e,t,n)=>!(!r[t.tagName]&&t.isEqualNode(n)),N=(e,t,n)=>t!==s.element||!t.isContentEditable,U=(e,t,n)=>{const{permanentAttributeName:r}=e;if(!r)return!0;const o=t.closest(`[${r}]`);if(!o&&t===s.element&&i(t)){const e={value:!0};return Array.from(n.attributes).forEach((n=>{e[n.name]||t.setAttribute(n.name,n.value)})),!1}return!o},k=[R,U,N],q=[];var D=Object.freeze({__proto__:null,didMorph:$,didMorphCallbacks:q,shouldMorph:L,shouldMorphCallbacks:k,verifyNotContentEditable:N,verifyNotMutable:R,verifyNotPermanent:U}),P={append:e=>{h(e,(t=>{y(t,e),g(e,(()=>{const{html:n,focusSelector:r}=e;t.insertAdjacentHTML("beforeend",A(n)),l(r)})),w(t,e)}))},graft:e=>{h(e,(t=>{y(t,e),g(e,(()=>{const{parent:n,focusSelector:r}=e,o=document.querySelector(n);o&&(o.appendChild(t),l(r))})),w(t,e)}))},innerHtml:e=>{h(e,(t=>{y(t,e),g(e,(()=>{const{html:n,focusSelector:r}=e;t.innerHTML=A(n),l(r)})),w(t,e)}))},insertAdjacentHtml:e=>{h(e,(t=>{y(t,e),g(e,(()=>{const{html:n,position:r,focusSelector:o}=e;t.insertAdjacentHTML(r||"beforeend",A(n)),l(o)})),w(t,e)}))},insertAdjacentText:e=>{h(e,(t=>{y(t,e),g(e,(()=>{const{text:n,position:r,focusSelector:o}=e;t.insertAdjacentText(r||"beforeend",A(n)),l(o)})),w(t,e)}))},outerHtml:e=>{h(e,(t=>{const n=t.parentElement,r=n&&Array.from(n.children).indexOf(t);y(t,e),g(e,(()=>{const{html:n,focusSelector:r}=e;t.outerHTML=A(n),l(r)})),w(n?n.children[r]:document.documentElement,e)}))},prepend:e=>{h(e,(t=>{y(t,e),g(e,(()=>{const{html:n,focusSelector:r}=e;t.insertAdjacentHTML("afterbegin",A(n)),l(r)})),w(t,e)}))},remove:e=>{h(e,(t=>{y(t,e),g(e,(()=>{const{focusSelector:n}=e;t.remove(),l(n)})),w(document,e)}))},replace:e=>{h(e,(t=>{const n=t.parentElement,r=n&&Array.from(n.children).indexOf(t);y(t,e),g(e,(()=>{const{html:n,focusSelector:r}=e;t.outerHTML=A(n),l(r)})),w(n?n.children[r]:document.documentElement,e)}))},textContent:e=>{h(e,(t=>{y(t,e),g(e,(()=>{const{text:n,focusSelector:r}=e;t.textContent=A(n),l(r)})),w(t,e)}))},addCssClass:e=>{h(e,(t=>{y(t,e),g(e,(()=>{const{name:n}=e;t.classList.add(...m([M(n)]))})),w(t,e)}))},removeAttribute:e=>{h(e,(t=>{y(t,e),g(e,(()=>{const{name:n}=e;t.removeAttribute(T(n))})),w(t,e)}))},removeCssClass:e=>{h(e,(t=>{y(t,e),g(e,(()=>{const{name:n}=e;t.classList.remove(...m([M(n)])),0===t.classList.length&&t.removeAttribute("class")})),w(t,e)}))},setAttribute:e=>{h(e,(t=>{y(t,e),g(e,(()=>{const{name:n,value:r}=e;t.setAttribute(T(n),A(r))})),w(t,e)}))},setDatasetProperty:e=>{h(e,(t=>{y(t,e),g(e,(()=>{const{name:n,value:r}=e;t.dataset[T(n)]=A(r)})),w(t,e)}))},setProperty:e=>{h(e,(t=>{y(t,e),g(e,(()=>{const{name:n,value:r}=e;n in t&&(t[T(n)]=A(r))})),w(t,e)}))},setStyle:e=>{h(e,(t=>{y(t,e),g(e,(()=>{const{name:n,value:r}=e;t.style[T(n)]=A(r)})),w(t,e)}))},setStyles:e=>{h(e,(t=>{y(t,e),g(e,(()=>{const{styles:n}=e;for(let[e,r]of Object.entries(n))t.style[T(e)]=A(r)})),w(t,e)}))},setValue:e=>{h(e,(t=>{y(t,e),g(e,(()=>{const{value:n}=e;t.value=A(n)})),w(t,e)}))},dispatchEvent:e=>{h(e,(t=>{y(t,e),g(e,(()=>{const{name:n,detail:r}=e;c(t,T(n),C(r))})),w(t,e)}))},setMeta:e=>{y(document,e),g(e,(()=>{const{name:t,content:n}=e;let r=document.head.querySelector(`meta[name='${t}']`);r||(r=document.createElement("meta"),r.name=T(t),document.head.appendChild(r)),r.content=A(n)})),w(document,e)},setTitle:e=>{y(document,e),g(e,(()=>{const{title:t}=e;document.title=A(t)})),w(document,e)},clearStorage:e=>{y(document,e),g(e,(()=>{const{type:t}=e;("session"===t?sessionStorage:localStorage).clear()})),w(document,e)},go:e=>{y(window,e),g(e,(()=>{const{delta:t}=e;history.go(t)})),w(window,e)},pushState:e=>{y(window,e),g(e,(()=>{const{state:t,title:n,url:r}=e;history.pushState(C(t),T(n),T(r))})),w(window,e)},redirectTo:e=>{y(window,e),g(e,(()=>{let{url:t,action:n,turbo:r}=e;n=n||"advance",t=T(t),void 0===r&&(r=!0),r?(window.Turbo&&window.Turbo.visit(t,{action:n}),window.Turbolinks&&window.Turbolinks.visit(t,{action:n}),window.Turbo||window.Turbolinks||(window.location.href=t)):window.location.href=t})),w(window,e)},reload:e=>{y(window,e),g(e,(()=>{window.location.reload()})),w(window,e)},removeStorageItem:e=>{y(document,e),g(e,(()=>{const{key:t,type:n}=e;("session"===n?sessionStorage:localStorage).removeItem(T(t))})),w(document,e)},replaceState:e=>{y(window,e),g(e,(()=>{const{state:t,title:n,url:r}=e;history.replaceState(C(t),T(n),T(r))})),w(window,e)},scrollIntoView:e=>{const{element:t}=e;y(t,e),g(e,(()=>{t.scrollIntoView(e)})),w(t,e)},setCookie:e=>{y(document,e),g(e,(()=>{const{cookie:t}=e;document.cookie=A(t)})),w(document,e)},setFocus:e=>{const{element:t}=e;y(t,e),g(e,(()=>{l(t)})),w(t,e)},setStorageItem:e=>{y(document,e),g(e,(()=>{const{key:t,value:n,type:r}=e;("session"===r?sessionStorage:localStorage).setItem(T(t),A(n))})),w(document,e)},consoleLog:e=>{y(document,e),g(e,(()=>{const{message:t,level:n}=e;n&&["warn","info","error"].includes(n)?console[n](t):console.log(t)})),w(document,e)},consoleTable:e=>{y(document,e),g(e,(()=>{const{data:t,columns:n}=e;console.table(t,S(n))})),w(document,e)},notification:e=>{y(document,e),g(e,(()=>{const{title:t,options:n}=e;Notification.requestPermission().then((r=>{e.permission=r,"granted"===r&&new Notification(T(t),C(n))}))})),w(document,e)},morph:t=>{h(t,(n=>{const{html:r}=t,o=document.createElement("template");o.innerHTML=String(A(r)).trim(),t.content=o.content;const a=n.parentElement,s=a&&Array.from(a.children).indexOf(n);y(n,t),g(t,(()=>{const{childrenOnly:r,focusSelector:a}=t;e(n,r?o.content:o.innerHTML,{childrenOnly:!!r,onBeforeElUpdated:L(t),onElUpdated:$(t)}),l(a)})),w(a?a.children[s]:document.documentElement,t)}))}};let _=P;const H=e=>{_={..._,...e}};var I={get all(){return _}};let j="warn";var z={get behavior(){return j},set(e){["warn","ignore","event","exception"].includes(e)?j=e:console.warn("Invalid 'onMissingElement' option. Defaulting to 'warn'.")}};const F=(e,t={onMissingElement:z.behavior})=>{const n={};e.forEach((e=>{e.batch&&(n[e.batch]=n[e.batch]?++n[e.batch]:1)})),e.forEach((e=>{const r=e.operation;try{if(e.selector?e.xpath?e.element=e.selectAll?d(e.selector):u(e.selector):e.element=e.selectAll?document.querySelectorAll(e.selector):document.querySelector(e.selector):e.element=document,e.element||"ignore"!==t.onMissingElement){s.set(document.activeElement);const t=I.all[r];t?(t(e),e.batch&&0==--n[e.batch]&&c(document,"cable-ready:batch-complete",{batch:e.batch})):console.error(`CableReady couldn't find the "${r}" operation. Make sure you use the camelized form when calling an operation method.`)}}catch(n){if(e.element)console.error(`CableReady detected an error in ${r||"operation"}: ${n.message}. If you need to support older browsers make sure you've included the corresponding polyfills. https://docs.stimulusreflex.com/setup#polyfills-for-ie11.`),console.error(n);else{const n=`CableReady ${r||""} operation failed due to missing DOM element for selector: '${e.selector}'`;switch(t.onMissingElement){case"ignore":break;case"event":c(document,"cable-ready:missing-element",{warning:n,operation:e});break;case"exception":throw n;default:console.warn(n)}}}}))};class X extends HTMLElement{static get tagName(){throw new Error("Implement the tagName() getter in the inheriting class")}static define(){customElements.get(this.tagName)||customElements.define(this.tagName,this)}disconnectedCallback(){this.channel&&this.channel.unsubscribe()}createSubscription(e,t,n){this.channel=e.subscriptions.create({channel:t,identifier:this.identifier},{received:n})}get preview(){return document.documentElement.hasAttribute("data-turbolinks-preview")||document.documentElement.hasAttribute("data-turbo-preview")}get identifier(){return this.getAttribute("identifier")}}let V;const Y=[25,50,75,100,200,250,500,800,1e3,2e3],Q=async(e=0)=>{if(V)return V;if(e>=Y.length)throw new Error("Couldn't obtain a Action Cable consumer within 5s");var t;return await(t=Y[e],new Promise((e=>setTimeout(e,t)))),await Q(e+1)};var Z={setConsumer(e){V=e},get consumer(){return V},getConsumer:async()=>await Q()};class B extends X{static get tagName(){return"cable-ready-stream-from"}async connectedCallback(){if(this.preview)return;const e=await Z.getConsumer();e?this.createSubscription(e,"CableReady::Stream",this.performOperations.bind(this)):console.error("The `cable_ready_stream_from` helper cannot connect. You must initialize CableReady with an Action Cable consumer.")}performOperations(e){e.cableReady&&F(e.operations,{onMissingElement:this.onMissingElement})}get onMissingElement(){const e=this.getAttribute("missing")||z.behavior;return["warn","ignore","event"].includes(e)?e:(console.warn("Invalid 'missing' attribute. Defaulting to 'warn'."),"warn")}}let W=!1;var G={get enabled(){return W},get disabled(){return!W},get value(){return W},set(e){W=!!e},set debug(e){W=!!e}};var J=(e,t)=>{G.disabled||console.log(`↑ Updatable request affecting ${t.length} element(s): `,{elements:t.map((e=>e.element)),identifiers:t.map((e=>e.element.getAttribute("identifier"))),data:e})},K=(e,t)=>{if(G.disabled)return;const n=new Date-e;console.log(`❌ Updatable request canceled after ${n}ms: ${t}`)},ee=(e,t,n)=>{if(G.disabled)return;const r=new Date-e;console.log(`↓ Updatable response: All URLs fetched in ${r}ms`,{element:t,urls:n})},te=(e,t)=>{if(G.disabled)return;const n=new Date-e;console.log(`↻ Updatable morph: starting after ${n}ms`,{element:t})},ne=(e,t)=>{if(G.disabled)return;const n=new Date-e;console.log(`↺ Updatable morph: completed after ${n}ms`,{element:t})};class re extends X{static get tagName(){return"cable-ready-updates-for"}constructor(){super();this.attachShadow({mode:"open"}).innerHTML="\n<style>\n  :host {\n    display: block;\n  }\n</style>\n<slot></slot>\n"}async connectedCallback(){if(this.preview)return;this.update=E(this.update.bind(this),this.debounce);const e=await Z.getConsumer();e?this.createSubscription(e,"CableReady::Stream",this.update):console.error("The `cable_ready_updates_for` helper cannot connect. You must initialize CableReady with an Action Cable consumer.")}async update(e){this.lastUpdateTimestamp=new Date;const t=Array.from(document.querySelectorAll(this.query),(e=>new oe(e))).filter((t=>t.shouldUpdate(e)));if(J(e,t),0===t.length)return void K(this.lastUpdateTimestamp,"All elements filtered out");if(t[0].element!==this)return void K(this.lastUpdateTimestamp,"Update already requested");s.set(document.activeElement),this.html={};const n=[...new Set(t.map((e=>e.url)))];await Promise.all(n.map((async e=>{if(!this.html.hasOwnProperty(e)){const t=await x(e,{"X-Cable-Ready":"update"});this.html[e]=await t.text()}}))),ee(this.lastUpdateTimestamp,this,n),this.index={},t.forEach((t=>{this.index.hasOwnProperty(t.url)?this.index[t.url]++:this.index[t.url]=0,t.process(e,this.html,this.index,this.lastUpdateTimestamp)}))}get query(){return`${this.tagName}[identifier="${this.identifier}"]`}get identifier(){return this.getAttribute("identifier")}get debounce(){return this.hasAttribute("debounce")?parseInt(this.getAttribute("debounce")):20}}class oe{constructor(e){this.element=e}async process(t,n,r,o){const a=r[this.url],s=document.createElement("template");this.element.setAttribute("updating","updating"),s.innerHTML=String(n[this.url]).trim(),await this.resolveTurboFrames(s.content);const i=s.content.querySelectorAll(this.query);if(i.length<=a)return void console.warn(`Update aborted due to insufficient number of elements. The offending url is ${this.url}.`);const u={element:this.element,html:i[a],permanentAttributeName:"data-ignore-updates"};c(this.element,"cable-ready:before-update",u),te(o,this.element),e(this.element,i[a],{childrenOnly:!0,onBeforeElUpdated:L(u),onElUpdated:e=>{this.element.removeAttribute("updating"),c(this.element,"cable-ready:after-update",u),l(u.focusSelector)}}),ne(o,this.element)}async resolveTurboFrames(e){const t=[...e.querySelectorAll('turbo-frame[src]:not([loading="lazy"])')];return Promise.all(t.map((e=>new Promise((async t=>{const n=await x(e.getAttribute("src"),{"Turbo-Frame":e.id,"X-Cable-Ready":"update"}),r=document.createElement("template");r.innerHTML=await n.text(),await this.resolveTurboFrames(r.content);const o=`turbo-frame#${e.id}`,a=r.content.querySelector(o),s=a?a.innerHTML.trim():"";docFragment.querySelector(o).innerHTML=s,t()})))))}shouldUpdate(e){return!this.ignoresInnerUpdates&&this.hasChangesSelectedForUpdate(e)}hasChangesSelectedForUpdate(e){const t=this.element.getAttribute("only");return!(t&&e.changed&&!t.split(" ").some((t=>e.changed.includes(t))))}get ignoresInnerUpdates(){return this.element.hasAttribute("ignore-inner-updates")&&this.element.hasAttribute("performing-inner-update")}get url(){return this.element.hasAttribute("url")?this.element.getAttribute("url"):location.href}get identifier(){return this.element.identifier}get query(){return this.element.query}}const ae=e=>{const t=e&&e.parentElement&&e.parentElement.closest("cable-ready-updates-for");t&&(t.setAttribute("performing-inner-update",""),ae(t))},se=e=>{const t=e&&e.parentElement&&e.parentElement.closest("cable-ready-updates-for");t&&(t.removeAttribute("performing-inner-update"),se(t))},ie=()=>{document.addEventListener("stimulus-reflex:before",(e=>{ae(e.detail.element)})),document.addEventListener("stimulus-reflex:after",(e=>{setTimeout((()=>{se(e.detail.element)}))})),document.addEventListener("turbo:submit-start",(e=>{ae(e.target)})),document.addEventListener("turbo:submit-end",(e=>{setTimeout((()=>{se(e.target)}))})),document.addEventListener("turbo-boost:command:start",(e=>{ae(e.target)})),document.addEventListener("turbo-boost:command:finish",(e=>{setTimeout((()=>{se(e.target)}))})),document.addEventListener("turbo-boost:command:error",(e=>{setTimeout((()=>{se(e.target)}))})),B.define(),re.define()},le={perform:F,performAsync:(e,t={onMissingElement:z.behavior})=>new Promise(((n,r)=>{try{n(F(e,t))}catch(e){r(e)}})),shouldMorphCallbacks:k,didMorphCallbacks:q,initialize:(e={})=>{const{consumer:t,onMissingElement:n,debug:r}=e;G.set(!!r),t?Z.setConsumer(t):console.error("CableReady requires a reference to your Action Cable `consumer` for its helpers to function.\nEnsure that you have imported the `CableReady` package as well as `consumer` from your `channels` folder, then call `CableReady.initialize({ consumer })`."),n&&MissingElement.set(n),ie()},addOperation:(e,t)=>{const n={};n[e]=t,H(n)},addOperations:e=>{H(e)},version:t,cable:Z,get DOMOperations(){return console.warn("DEPRECATED: Please use `CableReady.operations` instead of `CableReady.DOMOperations`"),I.all},get operations(){return I.all},get consumer(){return Z.consumer}};window.CableReady=le;export{D as MorphCallbacks,B as StreamFromElement,X as SubscribingElement,re as UpdatesForElement,O as Utils,le as default};
//# sourceMappingURL=cable_ready.min.js.map
